<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Web site created using create-react-app" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="face-api.js"></script>
    <link rel="stylesheet" href="css/tryout.css">

    <title>AR App</title>
</head>

<body>
    <div class="ar-window">
        <video onloadedmetadata="onPlay(this)" id="inputVideo" autoplay></video>
        <canvas id="overlay"></canvas>
    </div>
    <div class="App">
        <a href="triallist.html">
            <img src="images/arrow_back_24px.png" class="arrow">
        </a>

        <a href="checkout.html">
            <div class="btn1">
                <h1 class="button">CHECKOUT</h1>
            </div>
        </a>

        <!-- <div class="textbackground">
            <h1 class="text">Press anywhere on screen to click a photo</h1>
        </div> -->

        <button class="addtocart" id="cartbutton" value="cart">
            <img src="images/bag.png" class="bag_img">
        </button>

        <div class="addphoto">
            <img src="images/icons8-add-image-30.png" class="images">
        </div>

        <div class="medium-4  columns" id="cart">

            <div class="cart">
                <div class="row">
                    <div class="medium-6 columns">
                        <button class="tiny secondary" id="clear">Clear the cart</button>
                    </div>

                </div>
                <div id="cartItems">Loading cart...</div>
                Total price: <strong id="totalPrice">0 $</strong>
            </div>

        </div>

        <div class="addproduct">
            <h1>All Products </h1>
        </div>

        <img class="arrow2" src="images/expand_more_24px.png">

        <button class="addbutton" onclick="location.href='categories.html'">
            <h1 class="add">+ Add Product</h1>
        </button>

        <div class="lips">Lips</div>

        <hr class="lipsline">

        <div class="box1">
            <h1 class="name1">PAC Smudge Me Not Lipstick</h1>
            <img src="images/color1.png" class="smallcolor1">
            <div class="slidecontainer">
                <input type="range" min="20" max="100" value="60" class="slider" id="myRange" onchange ="updatePigmentation()">
            </div>
            <h1 class="price1">₹450/-</h1>
            <img class="dot1" src="images/dot.png">
            <img class="dot2" src="images/dot.png">
            <img class="dot3" src="images/dot.png">
            <h1 class="othershades">Other Shades</h1>
            <button class="color1" id="color1"></button>
            <button class="color2" onClick="updateColor('90001F')"></button>
            <button class="color3" onClick="updateColor('DB0734')"></button>
            <button class="color4" onClick="updateColor('a30e2d')"></button>
            <button class="color5" onClick="updateColor('721629')"></button>
            <button class="color6" onClick="updateColor('6d0505')"></button>
            <button class="color7" onClick="updateColor('41000e')"></button>
            <button class="color8" onClick="updateColor('721629')"></button>
            <div class="product medium-4 columns" dat-image="images/pac1.jpg" data-name="PAC Smudge Me Not Lipstick"
                data-price="450" data-id="0">
                <img class="lips1" src="images/pac1.jpg" alt="" />
                <input type="hidden" class="count" value="1" />
                <button class="btn2">
                    <h1 class="addtobag">Add to Bag</h1>
                </button>
            </div>
        </div>
    </div>

    <div class="box2">
        <h1 class="name2">Soft Matte Cream Lipstick</h1>
        <button class="smallcolor3"></button>
        <h1 class="price2">₹635/-</h1>
        <img class="dot4" src="images/dot.png">
        <img class="dot5" src="images/dot.png">
        <img class="dot6" src="images/dot.png">
        <!-- <button class="btn3">
                <h1 class="addtobag2">Add to Bag</h1>
            </button>-->
        <div class="product medium-4 columns" data-name="Soft Matte Cream Lipstick" data-price="653" data-id="1">
            <img class="lips2" src="images/pac2.jpg" alt="" />
            <input type="hidden" class="count" value="1" />
            <button class="btn3">
                <h1 class="addtobag2">Add to Bag</h1>
            </button>
        </div>
    </div>

    <!-- <div class="face">Face</div>
        <hr class="faceline"> -->

    <!-- <div class="box3"></div> -->


    </div>

    <script type="text/template" id="cartT">
        <% _.each(items, function (item) { %> <div class = "panel"> <h3> <%= item.name %> </h3>  <span class="label">
      <%= item.count %> piece<% if(item.count > 1)
      {%>s
      <%}%> for <%= item.total %>₹</span > </div>
      <% }); %>
      </script>

    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.5.2/underscore-min.js'></script>
    <script src="javascript/function.js"></script>
    <script src="http://code.jquery.com/jquery-latest.js"></script>

    <script type="text/javascript">

        $("#cart").hide();
        $("#cartbutton").click(function () {
            $("#cart").toggle();
        });

    </script>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>


<script>
    var ctx
    let inputSize = 608
    let scoreThreshold = 0.9;
    let forwardTimes = []
    let withLandmarks = false;
    let fillColor = "630015";
    let fillPigmenation = '99';
    const TINY_FACE_DETECTOR = 'tiny_face_detector'


    function updateColor(colorHex){
        $('#color1').attr('value', colorHex);
        fillColor = colorHex;
    }

    function updatePigmentation(){

        console.log('range value', $('#myRange').val() );
        let rangeVal = Math.ceil($('#myRange').val() / 5) * 5;          
        switch(rangeVal){
            case 10: fillPigmenation = '1a'; break;
            case 15: fillPigmenation = '26'; break;
            case 20: fillPigmenation = '33'; break;
            case 25: fillPigmenation = '40'; break;
            case 30: fillPigmenation = '4d'; break;
            case 35: fillPigmenation = '59'; break;
            case 40: fillPigmenation = '66'; break;
            case 45: fillPigmenation = '73'; break;
            case 50: fillPigmenation = '80'; break;
            case 55: fillPigmenation = '8c'; break;
            case 60: fillPigmenation = '99'; break;
            case 65: fillPigmenation = 'a6'; break;
            case 70: fillPigmenation = 'b3'; break;
            case 75: fillPigmenation = 'bf'; break;
            case 80: fillPigmenation = 'cc'; break;
            case 85: fillPigmenation = 'd9'; break;
            case 90: fillPigmenation = 'e6'; break;
            case 95: fillPigmenation = 'f2'; break;
            case 100: fillPigmenation = 'ff'; break;
            default:fillPigmenation = '99'; break;
        }
        console.log('pigmentation:',fillPigmenation);
    }

    function getCurrentFaceDetectionNet() {
        return faceapi.nets.tinyFaceDetector
    }

    function isFaceDetectionModelLoaded() {
        return !!getCurrentFaceDetectionNet().params
    }

    async function onPlay() {

        if (!isFaceDetectionModelLoaded()) {
            await getCurrentFaceDetectionNet().load('/models')
        }
        const videoEl = $('#inputVideo').get(0)
        if (videoEl.paused || videoEl.ended || !isFaceDetectionModelLoaded())
            return setTimeout(() => onPlay(), 50)

        const options = new faceapi.TinyFaceDetectorOptions({ inputSize, scoreThreshold })

        var result = await faceapi.detectSingleFace(videoEl, options).withFaceLandmarks()

        if (result) {
            const canvas = $('#overlay').get(0)
            const dims = faceapi.matchDimensions(canvas, videoEl, true)
            var resizedResult = faceapi.resizeResults(result, dims)

            if (withLandmarks) {
                faceapi.draw.drawFaceLandmarks(canvas, resizedResult)
            }

            var coordinates = resizedResult["landmarks"].getMouth()

            ctx = canvas.getContext("2d")

            ctx.fillStyle = '#'+fillColor+fillPigmenation;

            console.log('fillStyle', ctx.fillStyle);

            //upper lip 
            ctx.beginPath()
            ctx.moveTo(coordinates[0].x, coordinates[0].y)
            for (i = 1; i < 6; i++) {
                var xc = (coordinates[i].x + coordinates[i + 1].x) / 2
                var yc = (coordinates[i].y + coordinates[i + 1].y) / 2
                ctx.quadraticCurveTo(coordinates[i].x, coordinates[i].y, xc, yc)
            }

            ctx.lineTo(coordinates[15].x, coordinates[15].y);
            for (i = 15; i >= 13; i--) {
                var xc = (coordinates[i].x + coordinates[i - 1].x) / 2
                var yc = (coordinates[i].y + coordinates[i - 1].y) / 2
                ctx.quadraticCurveTo(coordinates[i].x, coordinates[i].y, xc, yc)
            }
            ctx.closePath();
            ctx.fill();

            // lower lip
            ctx.beginPath()
            ctx.moveTo(coordinates[6].x, coordinates[6].y)
            for (i = 6; i < 12; i++) {
                var xc = (coordinates[i].x + coordinates[i + 1].x) / 2
                var yc = (coordinates[i].y + coordinates[i + 1].y) / 2
                ctx.quadraticCurveTo(coordinates[i].x, coordinates[i].y, xc, yc)
            }

            for (i = 19; i >= 17; i--) {
                var xc = (coordinates[i].x + coordinates[i - 1].x) / 2
                var yc = (coordinates[i].y + coordinates[i - 1].y) / 2
                ctx.quadraticCurveTo(coordinates[i].x, coordinates[i].y, xc, yc)
            }
            ctx.closePath();
            ctx.fill();
        }
        setTimeout(() => onPlay());
    }

    async function run() {
        // load face detection and face landmark models
        await faceapi.loadFaceLandmarkModel('/models')


        // try to access users webcam and stream the images
        // to the video element
        var vid_constraints = {
            mandatory: {
                minHeight: 1920,
                minWidth: 1080
            }
        }
        var constraints = { audio: false, video: vid_constraints };
        const stream = await navigator.mediaDevices.getUserMedia({ video: {} })
        const videoEl = $('#inputVideo').get(0)
        videoEl.srcObject = stream
    }

    $(document).ready(function () {
        run()
    })

</script>

</html>